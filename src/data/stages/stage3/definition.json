{
  "id": "stage3_downtown",
  "name": "Downtown",
  "description": "The llamas head downtown, where Paul's 'projects' have attracted some attention. The city is destroyed. The police are gone. And Paul is proud.",

  "path": "both",

  "layout": {
    "archetypeId": "urban_downtown",
    "levelOverrides": {
      "0": {
        "totalRooms": { "min": 8, "max": 10 },
        "anchorRooms": [
          {
            "purpose": "downtown_entry",
            "gridPosition": { "x": 0, "z": 0 },
            "templateId": "city_block",
            "templateTags": ["city_block", "exterior"],
            "isEntry": true,
            "storyBeats": ["arrive_downtown"],
            "questItems": ["dropped_keys"]
          },
          {
            "purpose": "city_block",
            "gridPosition": { "x": 1, "z": 0 },
            "templateId": "city_block",
            "templateTags": ["city_block", "exterior"],
            "storyBeats": ["explore_downtown", "city_block_chaos"],
            "questItems": ["newspaper"]
          },
          {
            "purpose": "dark_alley",
            "gridPosition": { "x": 1, "z": -1 },
            "templateId": "alley",
            "templateTags": ["alley", "dark"],
            "storyBeats": ["alley_ambush"]
          },
          {
            "purpose": "plaza",
            "gridPosition": { "x": 2, "z": 0 },
            "templateId": "plaza",
            "templateTags": ["plaza", "exterior"],
            "storyBeats": ["plaza_discovery"]
          },
          {
            "purpose": "police_station",
            "gridPosition": { "x": 2, "z": 1 },
            "templateId": "building_interior",
            "templateTags": ["building", "interior"],
            "storyBeats": ["police_station_discovery"],
            "questItems": ["police_badge", "police_radio"]
          },
          {
            "purpose": "workshop",
            "gridPosition": { "x": 1, "z": 1 },
            "templateId": "building_interior",
            "templateTags": ["building", "interior"],
            "storyBeats": ["paul_workshop"]
          },
          {
            "purpose": "office",
            "gridPosition": { "x": 0, "z": 1 },
            "templateId": "building_interior",
            "templateTags": ["building", "interior"],
            "storyBeats": ["building_interior_discovery"],
            "questItems": ["marked_map"]
          },
          {
            "purpose": "highway_onramp",
            "gridPosition": { "x": 3, "z": 0 },
            "templateId": "city_block",
            "templateTags": ["city_block", "exterior"],
            "isExit": true,
            "storyBeats": ["final_choice"]
          }
        ]
      }
    }
  },

  "story": {
    "beats": [
      {
        "id": "arrive_downtown",
        "description": "Arrive in the devastated downtown area",
        "dialogueId": "stage3_arrive",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "entry" }
        },
        "consequences": {
          "nextBeat": "explore_downtown"
        }
      },
      {
        "id": "explore_downtown",
        "description": "Get your bearings in the chaos",
        "dialogueId": "stage3_explore_downtown",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "city_block" }
        },
        "consequences": {
          "horrorLevelChange": 1,
          "nextBeat": "city_block_chaos"
        }
      },
      {
        "id": "city_block_chaos",
        "description": "Discover Paul's been coming downtown for weeks",
        "dialogueId": "stage3_city_block_chaos",
        "trigger": {
          "type": "npc_interact",
          "params": { "npcId": "paul" }
        },
        "consequences": {
          "horrorLevelChange": 1,
          "nextBeat": "plaza_discovery"
        }
      },
      {
        "id": "alley_ambush",
        "description": "Discover Paul's graffiti tags and a fleeing figure in the dark alley",
        "dialogueId": "stage3_alley_ambush",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "dark_alley" }
        },
        "consequences": {
          "horrorLevelChange": 1
        }
      },
      {
        "id": "building_interior_discovery",
        "description": "Find the abandoned office with coffee still steaming",
        "dialogueId": "stage3_building_interior",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "office" }
        },
        "consequences": {
          "horrorLevelChange": 1,
          "spawnItems": ["marked_map"]
        }
      },
      {
        "id": "police_station_discovery",
        "description": "Find the empty police station",
        "dialogueId": "stage3_police_station",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "police_station" }
        },
        "consequences": {
          "horrorLevelChange": 2,
          "spawnItems": ["police_badge", "police_radio"]
        }
      },
      {
        "id": "paul_workshop",
        "description": "Discover Paul's horrifying workshop",
        "dialogueId": "stage3_paul_workshop",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "workshop" }
        },
        "consequences": {
          "horrorLevelChange": 2
        }
      },
      {
        "id": "plaza_discovery",
        "description": "Find the blood fountain in the plaza",
        "dialogueId": "stage3_plaza_discovery",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "plaza" }
        },
        "consequences": {
          "horrorLevelChange": 2,
          "nextBeat": "confrontation"
        }
      },
      {
        "id": "confrontation",
        "description": "Confront Paul about what he has done",
        "dialogueId": "stage3_confrontation",
        "trigger": {
          "type": "npc_interact",
          "params": { "npcId": "paul" }
        },
        "consequences": {
          "horrorLevelChange": 1,
          "unlockExits": ["highway_gate"],
          "nextBeat": "final_choice"
        }
      },
      {
        "id": "final_choice",
        "description": "Reach the highway and make the final choice",
        "dialogueId": "stage3_final_choice",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "highway_onramp" }
        },
        "consequences": {
          "stageComplete": true
        }
      }
    ],
    "goals": [
      {
        "id": "explore_city",
        "description": "Explore the devastated downtown",
        "type": "reach_scene",
        "params": { "sceneId": "city_block" }
      },
      {
        "id": "investigate_police",
        "description": "Check the police station for help",
        "type": "reach_scene",
        "params": { "sceneId": "police_station" },
        "hiddenUntil": "explore_downtown"
      },
      {
        "id": "find_evidence",
        "description": "Collect evidence of Paul's rampage",
        "type": "collect_items",
        "params": { "items": ["newspaper", "police_badge", "marked_map"] },
        "hiddenUntil": "city_block_chaos"
      },
      {
        "id": "find_plaza",
        "description": "Reach the town plaza",
        "type": "reach_scene",
        "params": { "sceneId": "plaza" },
        "hiddenUntil": "city_block_chaos"
      },
      {
        "id": "confront_paul",
        "description": "Confront Paul about the destruction",
        "type": "interact",
        "params": { "targetId": "paul" },
        "hiddenUntil": "plaza_discovery"
      },
      {
        "id": "find_escape",
        "description": "Find the highway and escape the city",
        "type": "reach_scene",
        "params": { "sceneId": "highway_onramp" },
        "hiddenUntil": "confrontation"
      }
    ],
    "startingBeat": "arrive_downtown",
    "completionGoals": ["find_escape"]
  },

  "generation": {
    "entryScene": {
      "templateId": "city_block",
      "templateTags": ["city_block", "exterior"],
      "purpose": "downtown_entry"
    },
    "exitScene": {
      "templateId": "city_block",
      "templateTags": ["city_block", "exterior"],
      "purpose": "highway_onramp"
    },
    "requiredScenes": [
      {
        "templateId": "city_block",
        "templateTags": ["city_block", "exterior"],
        "purpose": "city_block"
      },
      {
        "templateId": "plaza",
        "templateTags": ["plaza", "exterior"],
        "purpose": "plaza"
      },
      {
        "templateId": "alley",
        "templateTags": ["alley", "dark"],
        "purpose": "dark_alley"
      },
      {
        "templateId": "building_interior",
        "templateTags": ["building", "interior"],
        "purpose": "police_station"
      },
      {
        "templateId": "building_interior",
        "templateTags": ["building", "interior"],
        "purpose": "workshop"
      }
    ],
    "optionalSceneCount": { "min": 1, "max": 3 },
    "allowedTemplates": ["city_block", "alley", "plaza", "building_interior"],
    "palettes": ["urban_night"],
    "connectionRules": {
      "type": "branching",
      "maxDeadEnds": 3,
      "loopsAllowed": true,
      "maxDistanceFromEntry": 5
    },
    "environment": "mixed",
    "separation": "open"
  },

  "props": {
    "density": "cluttered",
    "questItems": [
      {
        "id": "police_badge",
        "name": "Officer Martinez's Badge",
        "description": "A half-crushed police badge. Badge number 4471.",
        "pickupDialogue": "stage3_pickup_badge",
        "examineDialogue": "stage3_examine_badge",
        "spawnRules": {
          "sceneTypes": ["police_station"],
          "zones": ["visible"],
          "requiredBeat": "police_station_discovery"
        }
      },
      {
        "id": "police_radio",
        "name": "Police Radio",
        "description": "A police radio still crackling with panicked static",
        "pickupDialogue": "stage3_pickup_radio",
        "examineDialogue": "stage3_examine_radio",
        "spawnRules": {
          "sceneTypes": ["police_station"],
          "zones": ["edge"],
          "requiredBeat": "police_station_discovery"
        }
      },
      {
        "id": "newspaper",
        "name": "Today's Newspaper",
        "description": "The headline reads: MYSTERIOUS DISAPPEARANCES REACH 200",
        "pickupDialogue": "stage3_pickup_newspaper",
        "examineDialogue": "stage3_examine_newspaper",
        "spawnRules": {
          "sceneTypes": ["city_block", "downtown_entry"],
          "zones": ["visible"]
        }
      },
      {
        "id": "dropped_keys",
        "name": "Dropped Keys",
        "description": "A ring of keys dropped on the pavement, still swinging",
        "pickupDialogue": "stage3_pickup_keys",
        "examineDialogue": "stage3_examine_keys",
        "spawnRules": {
          "sceneTypes": ["downtown_entry"],
          "zones": ["visible"]
        }
      },
      {
        "id": "marked_map",
        "name": "Marked City Map",
        "description": "A city map covered in red Xs tracking the disappearances",
        "pickupDialogue": "stage3_find_map",
        "examineDialogue": "stage3_examine_map",
        "spawnRules": {
          "sceneTypes": ["office"],
          "zones": ["hidden"],
          "requiredBeat": "building_interior_discovery"
        }
      }
    ],
    "propPools": ["urban_props", "debris"]
  },

  "npcs": {
    "required": [
      {
        "characterId": "paul",
        "behavior": "wander",
        "dialogueId": "stage3_paul_dialogue",
        "interactable": true,
        "spawnRoom": "downtown_entry",
        "wanderRooms": ["downtown_entry", "city_block", "plaza", "dark_alley"]
      }
    ],
    "optional": {
      "pool": ["citizen_panicked", "authority_figure"],
      "count": { "min": 1, "max": 2 }
    }
  },

  "atmosphere": {
    "baseHorrorLevel": 5,
    "horrorProgression": "increasing",
    "ambientSound": "ambient_city_chaos",
    "musicTrack": "music_tension_high",
    "perRoomOverrides": {
      "dark_alley": {
        "horrorLevel": 8,
        "ambientSound": "ambient_dripping",
        "musicTrack": "music_dread_rising"
      },
      "plaza": {
        "horrorLevel": 7,
        "musicTrack": "music_dread_rising"
      },
      "police_station": {
        "horrorLevel": 8,
        "ambientSound": "ambient_building_empty",
        "musicTrack": "music_dread_rising"
      },
      "workshop": {
        "horrorLevel": 9,
        "ambientSound": "ambient_building_empty",
        "musicTrack": "music_dread_rising"
      },
      "office": {
        "horrorLevel": 6,
        "ambientSound": "ambient_building_empty"
      },
      "highway_onramp": {
        "horrorLevel": 9,
        "musicTrack": "music_final_confrontation"
      }
    }
  },

  "estimatedDuration": 18,
  "difficulty": "medium"
}
