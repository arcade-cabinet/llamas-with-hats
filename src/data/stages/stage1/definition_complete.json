{
  "id": "stage1_apartment",
  "name": "The Morning After",
  "description": "Carl wakes up to find something terrible has happened. Again.",
  
  "path": "both",
  
  "story": {
    "beats": [
      {
        "id": "wake_up",
        "description": "Player wakes up in the living room",
        "dialogueId": "stage1_wake_up",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "living_room" }
        },
        "consequences": {
          "nextBeat": "explore_apartment"
        }
      },
      {
        "id": "explore_apartment",
        "description": "Player is encouraged to explore",
        "dialogueId": "stage1_explore",
        "trigger": {
          "type": "time_elapsed",
          "params": { "seconds": 10 }
        },
        "consequences": {
          "spawnItems": ["bloody_note"],
          "nextBeat": "discover_blood"
        }
      },
      {
        "id": "discover_blood",
        "description": "Player finds blood in the kitchen",
        "dialogueId": "stage1_blood_discovery",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "kitchen" }
        },
        "consequences": {
          "horrorLevelChange": 2,
          "spawnItems": ["basement_key"],
          "nextBeat": "find_key"
        }
      },
      {
        "id": "find_key",
        "description": "Player finds the basement key",
        "dialogueId": "stage1_key_found",
        "trigger": {
          "type": "item_pickup",
          "params": { "itemId": "basement_key" }
        },
        "consequences": {
          "unlockExits": ["basement_door"],
          "nextBeat": "basement_unlocked"
        }
      },
      {
        "id": "basement_unlocked",
        "description": "Basement is now accessible",
        "dialogueId": "stage1_basement_unlocked",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "hallway" }
        },
        "consequences": {
          "horrorLevelChange": 1,
          "nextBeat": "enter_basement"
        }
      },
      {
        "id": "enter_basement",
        "description": "Player descends into the basement",
        "dialogueId": "stage1_enter_basement",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "basement" }
        },
        "consequences": {
          "horrorLevelChange": 3,
          "nextBeat": "discover_horror"
        }
      },
      {
        "id": "discover_horror",
        "description": "Player discovers what Carl did",
        "dialogueId": "stage1_discover_horror",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "basement_back" }
        },
        "consequences": {
          "horrorLevelChange": 5,
          "unlockExits": ["exit_tunnel"],
          "nextBeat": "escape"
        }
      },
      {
        "id": "escape",
        "description": "Player escapes through the tunnel",
        "dialogueId": "stage1_escape",
        "trigger": {
          "type": "scene_enter",
          "params": { "sceneId": "exit" }
        },
        "consequences": {}
      }
    ],
    "goals": [
      {
        "id": "investigate_apartment",
        "description": "Investigate the apartment",
        "type": "reach_scene",
        "params": { "sceneId": "kitchen" }
      },
      {
        "id": "find_basement_key",
        "description": "Find the basement key",
        "type": "collect_items",
        "params": { "items": ["basement_key"] },
        "hiddenUntil": "discover_blood"
      },
      {
        "id": "explore_basement",
        "description": "Explore the basement",
        "type": "reach_scene",
        "params": { "sceneId": "basement" },
        "hiddenUntil": "find_key"
      },
      {
        "id": "escape_apartment",
        "description": "Find a way out",
        "type": "reach_scene",
        "params": { "sceneId": "exit" },
        "hiddenUntil": "discover_horror"
      }
    ],
    "startingBeat": "wake_up",
    "completionGoals": ["escape_apartment"]
  },
  
  "generation": {
    "layoutArchetype": "apartment_interior",
    
    "levels": [
      {
        "level": 0,
        "name": "Main Floor",
        "yOffset": 0,
        "pattern": "branching",
        "totalRooms": 7,
        "alignment": "organic",
        "anchorRooms": [
          {
            "id": "living_room",
            "purpose": "entry",
            "templateId": "room_medium",
            "gridPosition": { "x": 0, "z": 0 },
            "storyBeats": ["wake_up", "explore_apartment"],
            "required": true,
            "connections": ["hallway"],
            "props": {
              "required": ["couch", "table", "lamp"],
              "optional": ["rug", "bookshelf", "chair"]
            }
          },
          {
            "id": "hallway",
            "purpose": "connector",
            "templateId": "hallway_short",
            "gridPosition": { "x": 0, "z": -1 },
            "storyBeats": ["basement_unlocked"],
            "required": true,
            "connections": ["living_room", "kitchen", "bedroom", "bathroom", "basement_stairs"],
            "props": {
              "required": [],
              "optional": ["lamp", "rug"]
            }
          },
          {
            "id": "kitchen",
            "purpose": "story_critical",
            "templateId": "room_kitchen",
            "gridPosition": { "x": 1, "z": -1 },
            "storyBeats": ["discover_blood"],
            "required": true,
            "connections": ["hallway"],
            "questItems": ["basement_key"],
            "props": {
              "required": ["counter", "sink"],
              "optional": ["table", "chair", "barrel"]
            },
            "atmosphere": {
              "override": "uneasy",
              "bloodSplatter": true
            }
          },
          {
            "id": "bedroom",
            "purpose": "exploration",
            "templateId": "room_bedroom",
            "gridPosition": { "x": -1, "z": -1 },
            "required": true,
            "connections": ["hallway"],
            "props": {
              "required": ["bed"],
              "optional": ["dresser", "chair", "rug", "lamp"]
            }
          },
          {
            "id": "bathroom",
            "purpose": "exploration",
            "templateId": "room_bathroom",
            "gridPosition": { "x": -1, "z": -2 },
            "required": true,
            "connections": ["hallway"],
            "props": {
              "required": ["tub", "sink"],
              "optional": []
            }
          }
        ],
        "fillerRooms": {
          "count": { "min": 1, "max": 2 },
          "templates": ["room_small", "closet"],
          "spawnZone": { "minX": -2, "maxX": 2, "minZ": -3, "maxZ": 0 },
          "mustConnectToAnchor": true
        },
        "verticalConnections": [
          {
            "id": "basement_stairs",
            "type": "stairs",
            "fromRoom": "hallway",
            "position": { "x": 0, "z": -2 },
            "direction": "down",
            "targetLevel": -1,
            "targetRoom": "basement",
            "locked": true,
            "lockId": "basement_door",
            "unlockItem": "basement_key"
          }
        ]
      },
      {
        "level": -1,
        "name": "Basement",
        "yOffset": -4,
        "pattern": "linear",
        "totalRooms": 3,
        "alignment": "linear_north",
        "palette": "basement_damp",
        "anchorRooms": [
          {
            "id": "basement",
            "purpose": "story_critical",
            "templateId": "room_basement",
            "gridPosition": { "x": 0, "z": -2 },
            "storyBeats": ["enter_basement"],
            "required": true,
            "connections": ["basement_back"],
            "props": {
              "required": ["barrel", "crate"],
              "optional": ["pillar", "chest"]
            },
            "atmosphere": {
              "override": "tense",
              "fogDensity": 0.03
            }
          },
          {
            "id": "basement_back",
            "purpose": "story_critical",
            "templateId": "room_small",
            "gridPosition": { "x": 0, "z": -3 },
            "storyBeats": ["discover_horror"],
            "required": true,
            "connections": ["basement", "exit"],
            "props": {
              "required": ["suspicious_box"],
              "optional": ["barrel", "bloodstain"]
            },
            "atmosphere": {
              "override": "horror",
              "fogDensity": 0.05,
              "bloodSplatter": true
            }
          },
          {
            "id": "exit",
            "purpose": "exit",
            "templateId": "room_small",
            "gridPosition": { "x": 0, "z": -4 },
            "storyBeats": ["escape"],
            "required": true,
            "connections": ["basement_back"],
            "locked": true,
            "lockId": "exit_tunnel",
            "props": {
              "required": [],
              "optional": ["crate"]
            }
          }
        ],
        "fillerRooms": {
          "count": { "min": 0, "max": 1 },
          "templates": ["room_small"],
          "spawnZone": { "minX": -1, "maxX": 1, "minZ": -4, "maxZ": -2 }
        },
        "verticalConnections": [
          {
            "id": "stairs_up",
            "type": "stairs",
            "fromRoom": "basement",
            "position": { "x": 0, "z": -2 },
            "direction": "up",
            "targetLevel": 0,
            "targetRoom": "hallway"
          }
        ]
      }
    ],
    
    "entryScene": {
      "roomId": "living_room",
      "spawnPoint": { "x": 0, "z": 2 },
      "facing": "north"
    },
    
    "exitScene": {
      "roomId": "exit",
      "transitionTo": "stage2_town"
    },
    
    "connectionRules": {
      "type": "branching",
      "defaultConnectionType": "wall_door",
      "hallwayConnectionType": "wall_archway",
      "maxDeadEnds": 2,
      "loopsAllowed": false,
      "maxDistanceFromEntry": 5
    },
    
    "environment": "interior",
    "separation": "wall_door",
    
    "palettes": ["apartment_worn", "apartment_dark"],
    "basementPalettes": ["basement_damp"]
  },
  
  "props": {
    "density": "cluttered",
    "questItems": [
      {
        "id": "basement_key",
        "name": "Rusty Key",
        "description": "An old key with a tag that says 'BASEMENT'. It's covered in something red.",
        "model": "items/key.glb",
        "pickupDialogue": "stage1_pickup_key",
        "examineDialogue": "stage1_examine_key",
        "spawnRules": {
          "sceneId": "kitchen",
          "zone": "hidden",
          "position": { "near": "counter" },
          "requiredBeat": "discover_blood"
        }
      },
      {
        "id": "bloody_note",
        "name": "Blood-Stained Note",
        "description": "A crumpled note with something written on it. The handwriting is... familiar.",
        "pickupDialogue": "stage1_read_note",
        "examineDialogue": "stage1_examine_note",
        "spawnRules": {
          "sceneId": "living_room",
          "zone": "visible",
          "position": { "on": "table" },
          "requiredBeat": "explore_apartment"
        }
      },
      {
        "id": "photo_frame",
        "name": "Cracked Photo Frame",
        "description": "A photo of Carl and Paul. The glass is cracked right through the middle.",
        "examineDialogue": "stage1_examine_photo",
        "spawnRules": {
          "sceneId": "bedroom",
          "zone": "visible",
          "position": { "on": "dresser" }
        }
      }
    ],
    "propPools": ["apartment_furniture", "apartment_clutter", "horror_props"]
  },
  
  "npcs": {
    "required": [
      {
        "characterId": "paul",
        "sceneId": "living_room",
        "position": { "x": 2, "z": 0 },
        "behavior": "idle",
        "dialogueId": "stage1_paul_dialogue",
        "interactable": true,
        "dialogueTree": {
          "initial": {
            "lines": [
              { "speaker": "paul", "text": "Morning, Carl! Sleep well?" },
              { "speaker": "carl", "text": "Paul... what happened last night? I can't remember anything." },
              { "speaker": "paul", "text": "Oh, you know. The usual. Nothing to worry about!" }
            ],
            "options": [
              { "text": "What's that smell?", "next": "smell" },
              { "text": "Why is there red on your hands?", "next": "hands" },
              { "text": "I need to look around.", "next": "end" }
            ]
          },
          "smell": {
            "lines": [
              { "speaker": "paul", "text": "Smell? I don't smell anything. Maybe check the kitchen?" },
              { "speaker": "carl", "text": "Paul..." }
            ],
            "options": [
              { "text": "Why is there red on your hands?", "next": "hands" },
              { "text": "I'm going to look around.", "next": "end" }
            ]
          },
          "hands": {
            "lines": [
              { "speaker": "paul", "text": "Oh this? I was... making jam. Yes. Strawberry jam." },
              { "speaker": "carl", "text": "At 6 AM? We don't even have strawberries." },
              { "speaker": "paul", "text": "I improvised! You know me, always creative in the kitchen!" }
            ],
            "options": [
              { "text": "I need to check the kitchen.", "next": "end" }
            ]
          },
          "end": {
            "lines": [
              { "speaker": "paul", "text": "Sure thing, buddy! Let me know if you need anything!" }
            ],
            "options": []
          }
        }
      }
    ],
    "optional": {
      "pool": [],
      "count": { "min": 0, "max": 0 }
    }
  },
  
  "atmosphere": {
    "baseHorrorLevel": 2,
    "horrorProgression": "increasing",
    "horrorLevelsByRoom": {
      "living_room": 1,
      "hallway": 2,
      "kitchen": 4,
      "bedroom": 2,
      "bathroom": 3,
      "basement": 6,
      "basement_back": 9,
      "exit": 7
    },
    "ambientSound": "ambient_apartment_morning",
    "musicTrack": "music_uneasy",
    "soundsByRoom": {
      "basement": "ambient_basement_drip",
      "basement_back": "ambient_horror_drone"
    }
  },
  
  "dialogues": {
    "stage1_wake_up": {
      "lines": [
        { "speaker": "carl", "text": "Ugh... my head. What time is it?" },
        { "speaker": "narrator", "text": "The morning light filters through dusty curtains. Something feels... wrong." }
      ]
    },
    "stage1_explore": {
      "lines": [
        { "speaker": "carl", "text": "I should look around. Something doesn't feel right." }
      ]
    },
    "stage1_blood_discovery": {
      "lines": [
        { "speaker": "carl", "text": "What... what is this? Is that... blood?" },
        { "speaker": "carl", "text": "No. No no no. Not again. Please not again." }
      ]
    },
    "stage1_pickup_key": {
      "lines": [
        { "speaker": "carl", "text": "A key? It says 'BASEMENT' on the tag." },
        { "speaker": "carl", "text": "Why is it covered in... I don't want to know." }
      ]
    },
    "stage1_basement_unlocked": {
      "lines": [
        { "speaker": "carl", "text": "The basement. I have to check the basement." },
        { "speaker": "carl", "text": "I don't want to. But I have to know." }
      ]
    },
    "stage1_enter_basement": {
      "lines": [
        { "speaker": "narrator", "text": "The stairs creak with each step. The air grows cold and damp." },
        { "speaker": "carl", "text": "What's that smell? It's getting stronger..." }
      ]
    },
    "stage1_discover_horror": {
      "lines": [
        { "speaker": "carl", "text": "Oh god. Oh god oh god oh god." },
        { "speaker": "carl", "text": "PAUL! PAUL WHAT DID YOU DO?!" },
        { "speaker": "narrator", "text": "In the corner, something that was once human." }
      ]
    },
    "stage1_escape": {
      "lines": [
        { "speaker": "carl", "text": "I have to get out of here. I have to tell someone." },
        { "speaker": "carl", "text": "But who would believe me? Who would believe any of this?" }
      ]
    },
    "stage1_read_note": {
      "lines": [
        { "speaker": "narrator", "text": "The note reads: 'DON'T GO TO THE BASEMENT. -P'" },
        { "speaker": "carl", "text": "Paul... what did you do?" }
      ]
    }
  },
  
  "estimatedDuration": 15,
  "difficulty": "easy"
}
